name: Verify branch rules

on:
  push:
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify repo state (only on main)
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          fail() {
            echo "❌ $1" >&2
            exit 1
          }

          for b in main path truth; do
            git show-ref --verify --quiet "refs/remotes/origin/$b" \
              || fail "Remote branch 'origin/$b' does not exist"
          done

          git show "origin/path:path.txt" >/dev/null 2>&1 \
            || fail "Branch 'path' does not contain path.txt"

          git show "origin/truth:truth.txt" >/dev/null 2>&1 \
            || fail "Branch 'truth' does not contain truth.txt"

          git merge-base --is-ancestor origin/path origin/main \
            || fail "'path' has not been merged into 'main'"

          git merge-base --is-ancestor origin/truth origin/main \
            || fail "'truth' has not been merged into 'main'"

          mb_path=$(git merge-base origin/main origin/path)
          mb_truth=$(git merge-base origin/main origin/truth)

          if git merge-base --is-ancestor "$mb_truth" "$mb_path"; then
            fail "'truth' was merged before 'path' (wrong order)"
          fi

          echo "✅ All checks passed"
